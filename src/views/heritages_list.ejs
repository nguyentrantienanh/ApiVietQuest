<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Danh sách Di Sản</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
      body { padding: 2rem; background: #f8fafc; }
      .grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(300px,1fr)); gap: 1rem; }
      .card { border: 0; border-radius: 12px; overflow: hidden; box-shadow: 0 6px 18px rgba(22,28,45,0.06);} 
      .card .card-body { padding: 1rem; }
      .card-title { font-size: 1.05rem; font-weight: 600; margin-bottom: 0.25rem; }
      .meta { font-size: .85rem; color: #6c757d; }
      .desc { color: #495057; max-height: 3.6rem; overflow: hidden; }
      .carousel-img { height: 200px; object-fit: cover; }
      .thumb { height:60px; object-fit:cover; cursor:pointer; border-radius:6px; }
      .badges { gap: .5rem; display:flex; align-items:center; flex-wrap:wrap }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">Danh sách Di Sản</h2>
        <div>
          <a href="/heritages/new" class="btn btn-primary">Thêm Di Sản</a>
          <a href="/api/docs" class="btn btn-outline-secondary ms-2">Swagger</a>
        </div>
      </div>

      <% if (message) { %>
        <div class="alert alert-info"><%= message %></div>
      <% } %>

      <div class="grid">
        <% items.forEach(function(item){ %>
          <div class="card">
            <% // Build photos array: main img first (if exists), then photo_library avoiding duplicates %>
            <% const photos = [];
               if (item.img) photos.push(item.img);
               if (item.photo_library && item.photo_library.length) {
                 item.photo_library.forEach(p => { if (p && !photos.includes(p)) photos.push(p); });
               }
            %>

            <% if (photos.length) { %>
              <div id="carousel-<%= item.hid %>" class="carousel slide" data-bs-ride="false">
                <div class="carousel-inner">
                  <% photos.forEach(function(p, idx){ %>
                    <div class="carousel-item <%= idx===0 ? 'active' : '' %>">
                      <img src="<%= p %>" class="d-block w-100 carousel-img" alt="">
                    </div>
                  <% }) %>
                </div>
                <% if (photos.length > 1) { %>
                  <button class="carousel-control-prev" type="button" data-bs-target="#carousel-<%= item.hid %>" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                  </button>
                  <button class="carousel-control-next" type="button" data-bs-target="#carousel-<%= item.hid %>" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                  </button>
                <% } %>
              </div>

              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <div class="card-title"><%= item.name %></div>
                    <div class="meta">HID: <strong><%= item.hid %></strong> • <%= item.ward_codename %></div>
                  </div>
                  <div class="badges">
                    <% if (item.typeLabel || item.type) { %>
                      <span class="badge bg-info text-dark"><%= item.typeLabel || (item.type && item.type.replace(/_/g,' ')) %></span>
                    <% } %>
                    <% if (item.levelLabel || item.level) { %>
                      <span class="badge bg-warning text-dark"><%= item.levelLabel || (item.level && item.level.replace(/_/g,' ')) %></span>
                    <% } %>
                  </div>
                </div>

                <p class="desc mt-2"><%= item.Summary || item.Heritage || '' %></p>

                <div class="mt-3 d-flex justify-content-between align-items-center">
                  <div>
                    <a href="/heritages/<%= item.hid %>/edit" class="btn btn-sm btn-outline-primary">Sửa</a>
                    <form action="/heritages/<%= item.hid %>/delete" method="post" style="display:inline-block" onsubmit="return confirm('Bạn có chắc muốn xoá?');">
                      <button class="btn btn-sm btn-outline-danger ms-2">Xoá</button>
                    </form>
                  </div>
                  <div class="d-flex align-items-center">
                    <% if (photos.length > 1) { %>
                      <small class="text-muted me-2">Ảnh <span class="photo-count"><%= photos.length %></span></small>
                    <% } %>
                  </div>
                </div>

                 <% if (photos.length > 1) { %>
                  <div class="row g-2 mt-3">
                    <% photos.forEach(function(p, idx){ %>
                      <div class="col-3">
                        <img src="<%= p %>" class="thumb" data-bs-target="#carousel-<%= item.hid %>" data-bs-slide-to="<%= idx %>" />
                      </div>
                    <% }) %>
                  </div>
                <% } %>
              </div>

            <% } else { %>
              <div style="height:220px;background:#e9ecef;display:flex;align-items:center;justify-content:center;color:#6c757d">No Image</div>
              <div class="card-body">
                <div class="card-title"><%= item.name %></div>
                <div class="meta">HID: <strong><%= item.hid %></strong> • <%= item.ward_codename %></div>
                <p class="desc mt-2"><%= item.Summary || item.Heritage || '' %></p>
                <div class="mt-3">
                  <a href="/heritages/<%= item.hid %>/edit" class="btn btn-sm btn-outline-primary">Sửa</a>
                </div>
              </div>
            <% } %>
          </div>
        <% }) %>
      </div>

      <div class="mt-4">
        <% if (page > 1) { %>
          <a href="?page=<%= page-1 %>&limit=<%= limit %>" class="btn btn-outline-secondary">« Prev</a>
        <% } %>
        <span class="mx-2">Trang <%= page %></span>
        <% if (hasMore) { %>
          <a href="?page=<%= page+1 %>&limit=<%= limit %>" class="btn btn-outline-secondary">Next »</a>
        <% } %>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
